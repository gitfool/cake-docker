workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH !~ /^dependabot/'
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"'
    - when: never

variables:
  CAKE_SETTINGS_SHOWPROCESSCOMMANDLINE: "true"
  DOCKER_HOST: tcp://docker:2375
  DOTNET_CLI_TELEMETRY_OPTOUT: "true"
  DOTNET_NOLOGO: "true"
  DOTNET_ROLL_FORWARD_ON_NO_CANDIDATE_FX: 2
  GIT_DEPTH: 0

services:
  - docker:dind

stages: [ Build ]

Linux:
  stage: Build
  tags: [ shared, linux ]
  script:
    - curl -fsSL https://get.docker.com/ | bash -s
    - curl -fsSL https://dot.net/v1/dotnet-install.sh | bash -s -- --version 3.1.401
    - export DOTNET_ROOT=$HOME/.dotnet && export PATH=$DOTNET_ROOT:$PATH
    # Workaround GitVersion native dependency does not support Debian 10
    - dotnet tool install GitVersion.Tool --tool-path tools --version 5.3.7
    - export LD_LIBRARY_PATH=$(pwd)/tools/.store/gitversion.tool/5.3.7/gitversion.tool/5.3.7/tools/netcoreapp3.1/any/runtimes/debian.9-x64/native/
    - dotnet tool restore && dotnet cake --bootstrap --verbosity=verbose && dotnet cake --verbosity=verbose --target=build
